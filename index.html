<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>BEYBLADE X æ·˜æ±°è³½</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root {
  --bg: #0b0b0f;
  --card: #17171f;
  --accent: #ff3c3c;
  --win: #3cff8f;
  --secondary: #4a90e2;
  --text: #fff;
  --input-bg: #0e0e14;
  --border: #333;
}
body {
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  padding: 16px;
  margin: 0;
}
h1 {
  text-align: center;
  color: var(--accent);
  font-size: 28px;
  margin-bottom: 24px;
}
.input-card {
  background: linear-gradient(180deg, #1a1a24, #12121a);
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 8px 24px rgba(0,0,0,.4);
  margin-bottom: 24px;
}
.input-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 16px;
  color: var(--accent);
}
#playerList {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 16px;
}
.player-entry {
  display: flex;
  align-items: center;
  gap: 8px;
}
.player-entry input {
  flex: 1;
  padding: 12px 16px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--input-bg);
  color: var(--text);
  font-size: 16px;
}
.player-entry input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(255,60,60,0.3);
}
.player-entry button {
  background: var(--accent);
  color: var(--text);
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}
.player-entry button:hover {
  background: #e03030;
}
#addPlayer {
  background: var(--secondary);
  color: var(--text);
  border: none;
  border-radius: 999px;
  padding: 10px 20px;
  font-size: 15px;
  cursor: pointer;
  width: 100%;
  transition: background 0.2s;
}
#addPlayer:hover {
  background: #3a80d2;
}
.mode-selector {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
}
.mode-btn {
  flex: 1;
  background: #555;
  color: var(--text);
  border: none;
  border-radius: 999px;
  padding: 12px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}
.mode-btn.active {
  background: var(--accent);
}
.primary {
  background: var(--accent);
  color: var(--text);
  width: 100%;
  margin-top: 12px;
  border-radius: 999px;
  padding: 12px;
  font-size: 16px;
  cursor: pointer;
  transition: background 0.2s;
}
.primary:hover {
  background: #e03030;
}
.round {
  margin-top: 24px;
}
.match {
  background: var(--card);
  border-radius: 16px;
  padding: 16px;
  margin-top: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,.2);
  transition: transform 0.2s;
}
.match:hover {
  transform: translateY(-2px);
}
.vs {
  text-align: center;
  margin-bottom: 12px;
  font-weight: 600;
  font-size: 16px;
}
.buttons {
  display: flex;
  gap: 10px;
}
.buttons button {
  flex: 1;
  background: #222;
  color: var(--text);
  border: none;
  border-radius: 999px;
  padding: 10px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}
.buttons button.win {
  background: var(--win);
  color: #000;
}
.buttons button.lock {
  background: #555;
  opacity: .4;
}
.seed {
  text-align: center;
  color: var(--win);
  border: 1px solid var(--win);
  padding: 8px;
  border-radius: 12px;
  margin-top: 12px;
}
.next {
  margin-top: 24px;
  width: 100%;
  background: var(--accent);
  color: var(--text);
  padding: 12px;
  border-radius: 999px;
  font-size: 16px;
  cursor: pointer;
  transition: background 0.2s;
}
.next:hover {
  background: #e03030;
}
.life {
  font-size: 14px;
  opacity: .7;
  margin-left: 6px;
}

/* è¨˜åˆ†æ¿æ¨£å¼ */
.scoreboard {
  margin-top: 32px;
  background: var(--card);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,.2);
}
.scoreboard h3 {
  text-align: center;
  margin: 0 0 12px 0;
  font-size: 18px;
  color: var(--accent);
}
.scoreboard table {
  width: 100%;
  border-collapse: collapse;
}
.scoreboard th, .scoreboard td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid var(--border);
}
.scoreboard th {
  background: #222;
  font-weight: 600;
}
.scoreboard td.win-count {
  color: var(--win);
  font-weight: 700;
  font-size: 18px;
}

/* æ¯”åˆ†è¼¸å…¥æ¨£å¼ */
.score-inputs {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 12px;
  align-items: center;
}
.score-inputs input {
  width: 50px;
  text-align: center;
  background: #222;
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px;
  font-size: 16px;
}
.score-inputs .inc-dec-btn {
  background: #333;
  color: var(--text);
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}
.score-inputs .inc-dec-btn:hover {
  background: #444;
}
.score-inputs .score-group {
  display: flex;
  align-items: center;
  gap: 4px;
}

/* å† è»å‹•ç•« */
@keyframes popIn {
  0% { transform: scale(.5); opacity: 0 }
  70% { transform: scale(1.1); opacity: 1 }
  100% { transform: scale(1) }
}
@keyframes glow {
  0% { box-shadow: 0 0 10px rgba(255,215,0,.6) }
  50% { box-shadow: 0 0 30px rgba(255,215,0,1) }
  100% { box-shadow: 0 0 10px rgba(255,215,0,.6) }
}
.champion {
  margin-top: 40px;
  background: linear-gradient(135deg, #ffd700, #ff9f00);
  color: #000;
  padding: 26px;
  border-radius: 24px;
  text-align: center;
  animation: popIn .6s ease-out, glow 1.6s infinite;
  box-shadow: 0 8px 24px rgba(0,0,0,.4);
}
.champion .title {
  font-size: 22px;
  margin-bottom: 8px;
}
.champion .name {
  font-size: 36px;
  font-weight: 900;
}

/* é›™æ•—æ¨¡å¼ç‰¹å®šæ¨£å¼ */
.bracket {
  margin-top: 24px;
}
.bracket h3 {
  font-size: 18px;
  color: var(--secondary);
  margin-bottom: 12px;
}
</style>
</head>
<body>
<h1>BEYBLADE X æ·˜æ±°è³½</h1>
<div class="input-card">
  <div class="input-title">åƒè³½è€…åå–®</div>
  <div id="playerList"></div>
  <button id="addPlayer">æ·»åŠ åƒè³½è€…</button>
</div>
<div class="mode-selector">
  <button id="modeA" class="mode-btn active">å–®æ·˜æ±°è³½æ¨¡å¼</button>
  <button id="modeB" class="mode-btn">é›™æ¢å‘½æ¨¡å¼</button>
  <button id="modeC" class="mode-btn">é›™æ•—æ·˜æ±°è³½æ¨¡å¼</button>
  <button id="modeD" class="mode-btn">å¾ªç’°è³½æ¨¡å¼</button>
</div>
<button class="primary" id="start">ç”¢ç”Ÿç¬¬ä¸€è¼ª</button>
<div id="app"></div>
<button id="nextBtn" class="next" style="display:none;">é€²å…¥ä¸‹ä¸€è¼ª</button>

<script>
const app = document.getElementById("app");
const startBtn = document.getElementById("start");
const nextBtn = document.getElementById("nextBtn");
const modeA = document.getElementById("modeA");
const modeB = document.getElementById("modeB");
const modeC = document.getElementById("modeC");
const modeD = document.getElementById("modeD");
const playerList = document.getElementById("playerList");
const addPlayer = document.getElementById("addPlayer");

let mode = "A";
let currentPlayers = [];
let lives = {};
let round = 1;
let winners = [];
let seed = null;
let previousHadSeed = false;

/* å¾ªç’°è³½ç‹€æ…‹ */
let isRoundRobin = false;
let rrWins = {};
let rrLosses = {};
let rrMatches = [];
let matchElements = [];  // å„²å­˜æ¯å ´ match çš„ DOM å…ƒç´ 

/* é›™æ•—æ¨¡å¼ç‹€æ…‹ */
let winnersBracket = [];
let losersBracket = [];
let doubleElimRound = 1;
let finalMatch = false;
let champion = null;

/* æ¨¡å¼åˆ‡æ› */
function setMode(newMode, btn) {
  mode = newMode;
  [modeA, modeB, modeC, modeD].forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}
modeA.onclick = () => setMode("A", modeA);
modeB.onclick = () => setMode("B", modeB);
modeC.onclick = () => setMode("C", modeC);
modeD.onclick = () => setMode("D", modeD);

/* å„²å­˜åƒè³½è€…åå–® */
function savePlayers() {
  const names = extractNames();
  localStorage.setItem('beybladePlayers', JSON.stringify(names));
}

/* å‹•æ…‹æ·»åŠ åƒè³½è€… */
function addPlayerEntry(name = '') {
  const entry = document.createElement('div');
  entry.className = 'player-entry';
  entry.innerHTML = `
    <input type="text" value="${name}" placeholder="è¼¸å…¥åƒè³½è€…å§“å">
    <button>-</button>
  `;
  const input = entry.querySelector('input');
  input.addEventListener('input', savePlayers);
  entry.querySelector('button').onclick = () => {
    entry.remove();
    savePlayers();
  };
  playerList.appendChild(entry);
}
addPlayer.onclick = () => {
  addPlayerEntry();
  savePlayers();
};

function extractNames() {
  return Array.from(playerList.querySelectorAll('input'))
    .map(input => input.value.trim())
    .filter(Boolean);
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

/* å† è»é¡¯ç¤º */
function showChampion(name) {
  app.innerHTML = `
    <div class="champion">
      <div class="title">ğŸ† å† è»èª•ç”Ÿ ğŸ†</div>
      <div class="name">${name}</div>
    </div>`;
  nextBtn.style.display = "none";
}

/* é–‹å§‹æ¯”è³½ */
startBtn.onclick = () => {
  currentPlayers = extractNames();
  if (currentPlayers.length < 2) { alert("è‡³å°‘éœ€è¦2ä½é¸æ‰‹"); return; }
  savePlayers();  // é–‹å§‹æ™‚å„²å­˜
  winners = [];
  shuffle(currentPlayers);
  round = 1;
  isRoundRobin = false;
  previousHadSeed = false;
  if (mode === "B") {
    lives = {};
    currentPlayers.forEach(p => lives[p] = 2);
    renderRound();
  } else if (mode === "C") {
    winnersBracket = [...currentPlayers];
    losersBracket = [];
    doubleElimRound = 1;
    finalMatch = false;
    champion = null;
    renderDoubleElimRound();
  } else if (mode === "D") {
    startFullRoundRobin(currentPlayers);
  } else {
    renderRound();
  }
  nextBtn.style.display = (mode === "C" || mode === "D") ? "none" : "block";
};

/* ä¸‰å¼·æç¤º */
function showRoundRobinNotice(players) {
  app.innerHTML = `
    <div class="champion" style="animation:none;background:var(--card);color:var(--text);">
      âš ï¸ é€²å…¥ä¸‰å¼·å¾ªç’°è³½<br>
      <small>å…ˆå–å¾— 2 å‹è€…ç‚ºå† è»</small>
    </div>`;
  setTimeout(() => startRoundRobin(players), 1200);
}

/* å•Ÿå‹•ä¸‰å¼·å¾ªç’°è³½ */
function startRoundRobin(players) {
  isRoundRobin = true;
  rrWins = {};
  rrLosses = {};
  players.forEach(p => {
    rrWins[p] = 0;
    rrLosses[p] = 0;
  });
  rrMatches = [
    [players[0], players[1]],
    [players[0], players[2]],
    [players[1], players[2]]
  ];
  matchElements = [];
  renderRoundRobin("ä¸‰å¼·å¾ªç’°è³½");
  nextBtn.style.display = "none";
}

/* å•Ÿå‹•å®Œæ•´å¾ªç’°è³½ */
function startFullRoundRobin(players) {
  isRoundRobin = true;
  rrWins = {};
  rrLosses = {};
  players.forEach(p => {
    rrWins[p] = 0;
    rrLosses[p] = 0;
  });
  rrMatches = [];
  for (let i = 0; i < players.length; i++) {
    for (let j = i + 1; j < players.length; j++) {
      rrMatches.push([players[i], players[j]]);
    }
  }
  matchElements = [];
  renderRoundRobin("å¾ªç’°è³½");
  nextBtn.style.display = "none";
}

/* æ¸²æŸ“å¾ªç’°è³½ + æˆ°ç¸¾è¡¨ */
function renderRoundRobin(title) {
  app.innerHTML = `<h2>${title}</h2>`;

  rrMatches.forEach(([a, b]) => {
    const m = document.createElement("div");
    m.className = "match";
    m.innerHTML = `<div class="vs">${a} âš”ï¸ ${b}</div>`;
    const btns = document.createElement("div");
    btns.className = "buttons";

    const btnA = document.createElement("button");
    const btnB = document.createElement("button");
    btnA.textContent = a;
    btnB.textContent = b;

    let decided = null;

    function pickWinner(winnerPlayer, winnerBtn, loserBtn) {
      const loserPlayer = winnerPlayer === a ? b : a;
      if (decided === winnerPlayer) {
        // åæ‚”
        decided = null;
        winnerBtn.classList.remove("win");
        loserBtn.classList.remove("lock");

        rrWins[winnerPlayer]--;
        rrLosses[loserPlayer]--;

        updateScoreboard();
        document.getElementById("tie-button-container").innerHTML = '';
        return;
      }

      if (decided) return;

      decided = winnerPlayer;
      winnerBtn.classList.add("win");
      loserBtn.classList.add("lock");

      rrWins[winnerPlayer]++;
      rrLosses[loserPlayer]++;

      updateScoreboard();
      checkForCompletion();

      if (mode !== "D" && rrWins[winnerPlayer] === 2) {
        setTimeout(() => showChampion(winnerPlayer), 400);
      }
    }

    btnA.onclick = () => pickWinner(a, btnA, btnB);
    btnB.onclick = () => pickWinner(b, btnB, btnA);

    btns.append(btnA, btnB);
    m.append(btns);
    app.appendChild(m);
    matchElements.push(m);
  });

  const scoreboard = document.createElement("div");
  scoreboard.className = "scoreboard";
  scoreboard.innerHTML = `
    <h3>ç›®å‰æˆ°ç¸¾</h3>
    <table>
      <thead>
        <tr>
          <th>é¸æ‰‹</th>
          <th>å‹å ´</th>
          <th>æ•—å ´</th>
          <th>å‹ç‡</th>
          <th>å‹æ•—å·®è·</th>
        </tr>
      </thead>
      <tbody id="scoreboard-body"></tbody>
    </table>
    <div id="tie-button-container" style="text-align:center; margin-top:16px;"></div>
  `;
  app.appendChild(scoreboard);

  updateScoreboard();
}

/* æ›´æ–°è¨˜åˆ†æ¿ */
function updateScoreboard() {
  const tbody = document.getElementById("scoreboard-body");
  if (!tbody) return;

  tbody.innerHTML = "";

  const entries = Object.entries(rrWins)
    .map(([player, wins]) => {
      const losses = rrLosses[player];
      const total = wins + losses;
      const winRate = total > 0 ? (wins / total * 100).toFixed(2) + '%' : '0%';
      const diff = wins - losses;
      return { player, wins, losses, winRate, diff };
    })
    .sort((a, b) => b.wins - a.wins || b.diff - a.diff);

  entries.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.player}</td>
      <td class="win-count">${item.wins}</td>
      <td>${item.losses}</td>
      <td>${item.winRate}</td>
      <td>${item.diff}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* æª¢æŸ¥å¾ªç’°è³½å®Œæˆ */
function checkForCompletion() {
  const allDecided = matchElements.every(m => m.querySelector('.win'));
  if (allDecided) {
    const container = document.getElementById("tie-button-container");
    container.innerHTML = '';
    const btn = document.createElement("button");
    btn.textContent = "è³½äº‹çµæŸï¼ŒæŸ¥çœ‹æˆ°ç¸¾æ±ºå®šå† è»";
    btn.style.background = "var(--accent)";
    btn.style.color = "#fff";
    btn.style.padding = "10px 20px";
    btn.style.borderRadius = "999px";
    btn.onclick = () => {
      const entries = Object.entries(rrWins).map(([player, wins]) => {
        const diff = wins - rrLosses[player];
        return { player, diff };
      }).sort((a, b) => b.diff - a.diff);
      const champion = entries[0].player;
      setTimeout(() => showChampion(champion), 400);
    };
    container.appendChild(btn);
  } else {
    checkForTie();
  }
}

/* æª¢æŸ¥ä¸‰äººåŒç‚º1å‹1æ•— (åƒ…ä¸‰å¼·) */
function checkForTie() {
  if (mode !== "D" && rrMatches.length !== 3) return;
  const allDecided = matchElements.every(m => m.querySelector('.win'));
  const wins = Object.values(rrWins);
  if (allDecided && wins.every(w => w === 1)) {
    const container = document.getElementById("tie-button-container");
    container.innerHTML = '';
    const btn = document.createElement("button");
    btn.textContent = "ä¸‰äººæˆ°ç¸¾ç›¸åŒï¼Œéš¨æ©Ÿæ±ºå®šå† è»";
    btn.style.background = "var(--accent)";
    btn.style.color = "var(--text)";
    btn.style.padding = "10px 20px";
    btn.style.borderRadius = "999px";
    btn.style.cursor = "pointer";
    btn.onclick = () => {
      const players = Object.keys(rrWins);
      const champion = players[Math.floor(Math.random() * players.length)];
      setTimeout(() => showChampion(champion), 400);
    };
    container.appendChild(btn);
  }
}

/* æ¸²æŸ“ä¸€èˆ¬æ·˜æ±°è³½ (A/B æ¨¡å¼) */
function renderRound() {
  app.innerHTML = "";
  winners = [];
  let div = document.createElement("div");
  div.className = "round";
  div.innerHTML = `<h2>ç¬¬ ${round} è¼ª</h2>`;
  app.appendChild(div);

  let players = [...currentPlayers];
  seed = null;
  if (players.length % 2 === 1) {
    seed = players.splice(Math.floor(Math.random() * players.length), 1)[0];
  }

  for (let i = 0; i < players.length; i += 2) {
    const a = players[i], b = players[i + 1];
    const m = document.createElement("div");
    m.className = "match";
    m.innerHTML = `<div class="vs">
      ${a}${mode === "B" ? " â¤ï¸".repeat(lives[a] || 0) : ""} âš”ï¸
      ${b}${mode === "B" ? " â¤ï¸".repeat(lives[b] || 0) : ""}
    </div>`;
    const btns = document.createElement("div");
    btns.className = "buttons";
    const btnA = document.createElement("button");
    const btnB = document.createElement("button");
    btnA.textContent = a; btnB.textContent = b;

    let decided = null;

    function selectWinner(winner, winBtn, loseBtn) {
      const loser = winner === a ? b : a;
      if (decided === winner) {
        decided = null;
        winBtn.classList.remove("win");
        loseBtn.classList.remove("lock");
        winners = winners.filter(p => p !== winner);
        if (mode === "B") lives[loser]++;
        return;
      }
      if (decided) return;
      decided = winner;
      winBtn.classList.add("win");
      loseBtn.classList.add("lock");
      winners.push(winner);
      if (mode === "B") {
        lives[loser]--;
        if (lives[loser] > 0 && !winners.includes(loser)) {
          winners.push(loser);
        }
      }
    }

    btnA.onclick = () => selectWinner(a, btnA, btnB);
    btnB.onclick = () => selectWinner(b, btnB, btnA);
    btns.append(btnA, btnB);
    m.append(btns);
    div.appendChild(m);
  }

  if (seed) {
    winners.push(seed);
    const s = document.createElement("div");
    s.className = "match seed";
    s.innerHTML = `ç¨®å­é¸æ‰‹ï¼š${seed}${mode === "B" ? " â¤ï¸".repeat(lives[seed] || 0) : ""}`;
    div.appendChild(s);
  }

  previousHadSeed = !!seed;
}

/* ä¸‹ä¸€è¼ª (A/B æ¨¡å¼) */
nextBtn.onclick = () => {
  currentPlayers = winners.filter(p => mode !== "B" || (lives[p] !== undefined && lives[p] > 0));
  if (currentPlayers.length === 1) {
    showChampion(currentPlayers[0]);
    return;
  }
  if (mode === "A" && currentPlayers.length === 3 && previousHadSeed) {
    showRoundRobinNotice(currentPlayers);
    return;
  }
  shuffle(currentPlayers);
  round++;
  renderRound();
};

/* é›™æ•—æ·˜æ±°è³½æ¸²æŸ“ */
function renderDoubleElimRound() {
  app.innerHTML = "";
  let div = document.createElement("div");
  div.className = "bracket";
  div.innerHTML = `<h2>ç¬¬ ${doubleElimRound} è¼ª - é›™æ•—æ·˜æ±°è³½</h2>`;
  app.appendChild(div);

  // è´è€…çµ„
  const winnersDiv = document.createElement("div");
  winnersDiv.innerHTML = `<h3>è´è€…çµ„</h3>`;
  let newWinnersBracket = [];
  let newLosers = [];
  let wbPlayers = [...winnersBracket];
  shuffle(wbPlayers);
  for (let i = 0; i < wbPlayers.length; i += 2) {
    if (i + 1 < wbPlayers.length) {
      const a = wbPlayers[i], b = wbPlayers[i + 1];
      const m = createMatch(a, b, (winner, loser) => {
        newWinnersBracket.push(winner);
        newLosers.push(loser);
      });
      winnersDiv.appendChild(m);
    } else {
      // è¼ªç©º
      newWinnersBracket.push(wbPlayers[i]);
      const s = document.createElement("div");
      s.className = "match seed";
      s.innerHTML = `è¼ªç©ºï¼š${wbPlayers[i]}`;
      winnersDiv.appendChild(s);
    }
  }
  div.appendChild(winnersDiv);

  // è¼¸è€…çµ„
  const losersDiv = document.createElement("div");
  losersDiv.innerHTML = `<h3>è¼¸è€…çµ„</h3>`;
  let newLosersBracket = [];
  let lbPlayers = [...losersBracket];
  shuffle(lbPlayers);
  for (let i = 0; i < lbPlayers.length; i += 2) {
    if (i + 1 < lbPlayers.length) {
      const a = lbPlayers[i], b = lbPlayers[i + 1];
      const m = createMatch(a, b, (winner, loser) => {
        newLosersBracket.push(winner);
        // è¼¸è€…æ·˜æ±°ï¼Œä¸åŠ å›
      });
      losersDiv.appendChild(m);
    } else {
      // è¼ªç©º
      newLosersBracket.push(lbPlayers[i]);
      const s = document.createElement("div");
      s.className = "match seed";
      s.innerHTML = `è¼ªç©ºï¼š${lbPlayers[i]}`;
      losersDiv.appendChild(s);
    }
  }
  div.appendChild(losersDiv);

  // ä¸‹ä¸€è¼ªæŒ‰éˆ• (è‡ªè¨‚ for é›™æ•—)
  const nextDoubleBtn = document.createElement("button");
  nextDoubleBtn.className = "next";
  nextDoubleBtn.textContent = "é€²å…¥ä¸‹ä¸€è¼ª";
  nextDoubleBtn.onclick = () => {
    winnersBracket = newWinnersBracket;
    losersBracket = [...newLosersBracket, ...newLosers];  // è¼¸è€…çµ„åŠ å…¥æ–°è¼¸è€…
    if (winnersBracket.length + losersBracket.length < 2) {
      showChampion(winnersBracket[0] || losersBracket[0]);
      return;
    }
    if (winnersBracket.length === 1 && losersBracket.length === 1) {
      renderFinalMatch(winnersBracket[0], losersBracket[0]);
      return;
    }
    doubleElimRound++;
    renderDoubleElimRound();
  };
  app.appendChild(nextDoubleBtn);
}

/* å‰µå»ºæ¯”è³½å…ƒç´  for é›™æ•— */
function createMatch(a, b, onDecide) {
  const m = document.createElement("div");
  m.className = "match";
  m.innerHTML = `<div class="vs">${a} âš”ï¸ ${b}</div>`;
  const btns = document.createElement("div");
  btns.className = "buttons";
  const btnA = document.createElement("button");
  const btnB = document.createElement("button");
  btnA.textContent = a;
  btnB.textContent = b;

  let decided = null;

  function selectWinner(winner, winBtn, loseBtn, loser) {
    if (decided === winner) {
      decided = null;
      winBtn.classList.remove("win");
      loseBtn.classList.remove("lock");
      return;
    }
    if (decided) return;
    decided = winner;
    winBtn.classList.add("win");
    loseBtn.classList.add("lock");
    onDecide(winner, loser);
  }

  btnA.onclick = () => selectWinner(a, btnA, btnB, b);
  btnB.onclick = () => selectWinner(b, btnB, btnA, a);
  btns.append(btnA, btnB);
  m.append(btns);
  return m;
}

/* æœ€çµ‚æ±ºè³½ for é›™æ•— */
function renderFinalMatch(winnerChamp, loserChamp) {
  app.innerHTML = "";
  let div = document.createElement("div");
  div.className = "round";
  div.innerHTML = `<h2>æœ€çµ‚æ±ºè³½</h2>`;
  app.appendChild(div);

  const m = createMatch(winnerChamp, loserChamp, (winner, loser) => {
    if (winner === winnerChamp) {
      champion = winnerChamp;
    } else {
      // è¼¸è€…çµ„è´ï¼Œéœ€å†æ¯”ä¸€å ´ (å› è´è€…çµ„åªè¼¸ä¸€æ¬¡)
      finalMatch = true;
    }
  });
  div.appendChild(m);

  const confirmBtn = document.createElement("button");
  confirmBtn.className = "next";
  confirmBtn.textContent = "ç¢ºèªçµæœ";
  confirmBtn.onclick = () => {
    if (champion) {
      showChampion(champion);
    } else if (finalMatch) {
      renderSecondFinal(winnerChamp, loserChamp);
    }
  };
  app.appendChild(confirmBtn);
}

/* ç¬¬äºŒå ´æ±ºè³½ if needed */
function renderSecondFinal(winnerChamp, loserChamp) {
  app.innerHTML = "";
  let div = document.createElement("div");
  div.className = "round";
  div.innerHTML = `<h2>ç¬¬äºŒå ´æ±ºè³½ (æ±ºå®šå† è»)</h2>`;
  app.appendChild(div);

  const m = createMatch(winnerChamp, loserChamp, (winner) => {
    champion = winner;
  });
  div.appendChild(m);

  const confirmBtn = document.createElement("button");
  confirmBtn.className = "next";
  confirmBtn.textContent = "ç¢ºèªå† è»";
  confirmBtn.onclick = () => {
    if (champion) {
      showChampion(champion);
    }
  };
  app.appendChild(confirmBtn);
}

/* é é¢è¼‰å…¥æ™‚å¾ localStorage è¼‰å…¥åå–® */
document.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('beybladePlayers');
  if (saved) {
    const players = JSON.parse(saved);
    playerList.innerHTML = '';
    players.forEach(addPlayerEntry);
  } else {
    addPlayerEntry();
  }
});
</script>
</body>
</html>
